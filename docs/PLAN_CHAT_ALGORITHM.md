# 플랜 챗 알고리즘 문서

## 개요
플랜 챗(Route Recommendation)은 사용자의 취향과 GPS 위치를 기반으로 최적의 여행 일정을 추천하는 시스템입니다.

## 알고리즘 플로우

```
[사용자 입력]
    ↓
[취향 분석] → [완료한 퀘스트 조회] → [후보 퀘스트 수집]
    ↓
[점수 계산]
    ├─ 카테고리 매칭 점수 (30%)
    ├─ 거리 점수 (25%)
    ├─ 다양성 점수 (20%)
    ├─ 인기도 점수 (15%)
    └─ 포인트 점수 (10%)
    ↓
[정렬 및 필터링]
    ├─ 출발 지점 기준 거리순 정렬
    ├─ 야경 특별 장소 분리
    └─ DB 검증 (실제 존재하는 장소만)
    ↓
[최종 추천]
    ├─ 일반 퀘스트 3개 (출발지점 기준 가까운 순)
    └─ 야경 특별 장소 1개 (마지막 장소)
```

## 상세 알고리즘

### 1. 사용자 취향 분석
- `preferences`에서 카테고리/테마 추출
- 한글-영어 카테고리 정규화

### 2. 완료한 퀘스트 조회
- 사용자가 완료한 퀘스트 ID 수집
- 완료한 카테고리 집합 생성 (다양성 점수 계산용)

### 3. 후보 퀘스트 수집
- GPS 위치가 있으면: 반경 15km 내 퀘스트 조회
- GPS 위치가 없으면: 전체 활성 퀘스트 중 상위 50개

### 4. 점수 계산

#### 4.1 카테고리 매칭 점수 (가중치: 30%)
- 정확히 일치: 1.0
- 유사 카테고리: 0.7
- 관련 없음: 0.3

#### 4.2 거리 점수 (가중치: 25%)
- 출발 지점 지정 시: `start_latitude`, `start_longitude` 사용
- 미지정 시: 현재 GPS 위치(`latitude`, `longitude`) 사용
- 15km 이내: `1.0 - (distance_km / 15.0)`
- 15km 초과: 0.1

#### 4.3 다양성 점수 (가중치: 20%)
- 완료한 카테고리와 다름: 1.0
- 완료한 카테고리와 같음: 0.3

#### 4.4 인기도 점수 (가중치: 15%)
- `completion_count / 100.0` (최대 1.0)

#### 4.5 포인트 점수 (가중치: 10%)
- `reward_point / 200.0` (최대 1.0)

### 5. 정렬 및 필터링

#### 5.1 출발 지점 기준 정렬
- 출발 지점이 지정되거나 GPS 위치가 있으면 거리순 정렬
- 없으면 점수순 정렬

#### 5.2 야경 특별 장소 분리
야경 특별 장소 판별 기준:
- `metadata`에 "night_view", "night_scene", "night_viewing", "야경", "야경명소" 포함
- `description`에 "night view", "night scene", "야경", "야경명소", "야경 포인트" 포함
- `name`에 "night view", "야경" 포함

#### 5.3 DB 검증
- Pinecone에서 반환된 장소가 실제 DB에 존재하는지 확인
- `is_active = TRUE`인 장소만 사용

### 6. 최종 추천
- 일반 퀘스트: 출발 지점 기준 가까운 순으로 3개 선택
- 야경 특별 장소: 마지막 장소로 1개 선택 (가능한 경우)
- 총 4개 퀘스트 추천

## AI 기반 추천 (선택적)

환경 변수 `USE_AI_ROUTE_RECOMMENDATION=true`일 경우:
- 상위 20개 후보를 AI(Gemini)에 전달
- AI가 최적의 4개 퀘스트 선택
- AI 추천 실패 시 점수 기반 추천으로 폴백

## 시각화

### 점수 계산 가중치
```
┌─────────────────────────────────────┐
│  카테고리 매칭: 30%                 │
│  거리: 25%                          │
│  다양성: 20%                        │
│  인기도: 15%                        │
│  포인트: 10%                        │
└─────────────────────────────────────┘
```

### 추천 플로우
```
[후보 퀘스트 수집]
        ↓
[점수 계산 및 정렬]
        ↓
    ┌───┴───┐
    │       │
[일반]   [야경]
    │       │
   3개     1개
    │       │
    └───┬───┘
        ↓
  [최종 4개]
```

## 주요 개선 사항

1. **출발 지점 지정 지원**: `start_latitude`, `start_longitude` 추가
2. **야경 특별 장소 추천**: 마지막 장소로 야경 포인트 자동 추천
3. **DB 검증 강화**: 실제 존재하는 장소만 추천
4. **거리 기반 정렬**: 출발 지점 기준 가까운 순 정렬

## API 엔드포인트

```
POST /ai-station/route-recommend
```

### Request Body
```json
{
  "preferences": {
    "theme": "Culture",
    "category": {"name": "history"},
    "districts": ["Jongno-gu"]
  },
  "latitude": 37.5665,
  "longitude": 126.9780,
  "start_latitude": 37.5665,  // 선택적
  "start_longitude": 126.9780, // 선택적
  "must_visit_place_id": "uuid" // 선택적
}
```

### Response
```json
{
  "success": true,
  "quests": [
    {
      "id": 1,
      "name": "Gyeongbokgung Palace",
      "recommendation_score": 0.85,
      "distance_from_start": 0.5,
      ...
    },
    ...
  ],
  "count": 4,
  "session_id": "uuid"
}
```

## 성능 최적화

1. **후보 수집 제한**: 최대 50개 후보만 처리
2. **인덱스 활용**: GPS 위치 기반 인덱스 사용
3. **캐싱**: 완료한 퀘스트 정보 캐싱 가능

## 향후 개선 방향

1. **실시간 교통 정보 반영**: 거리 계산 시 교통 상황 고려
2. **시간대별 추천**: 오전/오후/저녁 시간대별 최적 경로
3. **그룹 추천**: 여러 사용자 취향을 종합한 그룹 일정
4. **동적 가중치**: 사용자 피드백 기반 가중치 조정
